@echo off
jq -r --arg mdsnippet "```" --arg flexstart "<div style=\"display: flex\">" --arg flexstop "</div>" --arg cellstart "<div style=\"flex: 50%%; max-width:50%%;\">" --arg cellstop "</div>" "reduce [[[.log.entries[] | select(.response.headers | any(.name == \"content-type\" and (.value | test(\"^(audio^|image^|video)\") | not)))][] | {\"body\": (if .request.postData?.text? then (.request.postData.text) else null end), \"method\": .request.method, \"url\": .request.url, \"headers\": (.request.headers | del(.[] | select(.name == (\"Expires\", \"Pragma\", \"Cache-Control\", \"TE\", \"Connection\", \"Accept-Language\", \"Host\", \"Origin\", \"Accept-Encoding\", \"Access-Control-Request-Method\", \"Access-Control-Request-Headers\", \"Referer\", \"Accept\", \"User-Agent\", \"X-XSRF-TOKEN\", \"Cookie\"))) | sort_by(.value | length)), \"responseStatus\": \"\(.response.status) \(.response.statusText?)\", \"responseSize\": \"\(.response.content.size)\", \"responseBody\": \"\(if .response.content.text != \"\" then (.response.content.text + (if .response.content.text != [] then \"\" else \"\n\" end)) else \"\" end)\"}][] | \"\($flexstart)\($cellstart)\n\n#### Request\n\($mdsnippet)\n\", \"curl.exe -X \(.method)\" + \" \\\"\(.url)\\\"\n--verbose --silent\n\", (.headers[] | \"-H \\\"\(.name): \(.value)\\\"\n\"), (if .body then \"-d \\\"\(.body | gsub(\"\\\\\\\"\"; \"\\\"\\\"\"))\\\"\n\" else empty end), \"\($mdsnippet)\n\($cellstop)\($cellstart)\n\n\", \"#### Response\n##### \(if .responseStatus | startswith(\"2\") then \"âœ…\" else \"ðŸš«\" end) \(.responseStatus)\", \"\n\", (if .responseBody and .responseBody != \"\" then \"\n\($mdsnippet)\n\(if (.responseSize | tonumber) < 9999 then \"\(.responseBody ^| fromjson ^| .)\" else \"[\(.responseSize) chars] - Too long to display.\nBeginning looks like this:\n\n\(.responseBody[:100])\" end)\n\($mdsnippet)\n\" else empty end), \"\($cellstop)\($flexstop)\", \"\n\n\"][] as $itm (\"\"; . + $itm)" %*
